* Week 4: picking up storms project and going beyond

*** Getting our data
CSV release of our data on the NOAA website:

#+BEGIN_SRC R
ftp://eclipse.ncdc.noaa.gov/pub/ibtracs/v03r10/all/csv/basin
#+END_SRC

(the file is too big to re-distribute: do download and copy to ~data/~ directory please)

*** Loading packages and data
#+BEGIN_SRC R
library(ggplot2)
library(dplyr)
library(readr)

# data source
basin <- read.csv("data/Basin.WP.ibtracs_all.v03r10.csv",
                  skip = 1, stringsAsFactors = FALSE)
basin <- basin[-1, ] # first column is garbled, disegard
#+END_SRC

**** Preparing our data further...
#+BEGIN_SRC R
# cleaner columns
basin$Season <- as.numeric(basin$Season)
basin$Name <- as.factor(basin$Name)

# remove whitespace in numbers
basin$Latitude <- as.numeric(gsub("^ ", "", basin$Latitude))
basin$Longitude <- as.numeric(gsub("^ ", "", basin$Longitude))
basin$Wind.WMO. <- as.numeric(gsub("^ ", "", basin$Wind.WMO.))
#+END_SRC

*** Filter 2000 to 2017
For the purpose of this exercise we're only interested in the years 2000 to 2017

#+BEGIN_SRC R
substorms <- basin %>%
  filter(Season %in% 2000:2017,
        !Name == "NOT NAMED",
	!Latitude == -999,
	!Longitude == -999)

substorms$ID <- as.factor(paste(substorms$Name, substorms$Season, 
                                sep <- "."))
#+END_SRC


**** Let's map 
#+BEGIN_SRC R
ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) + 
  geom_polygon(data = map_data("world"), aes(x = long, y = lat, group = group)) +
  geom_path(data = substorms, aes(group = ID))
#+END_SRC

[[fig3/Rplot01.png]]

*** Themes in ggplot
#+BEGIN_SRC R
theme_opts<-list(theme(panel.grid.minor = element_blank(),
                       panel.grid.major = element_blank(),
                       panel.background = element_blank(),
                       plot.background = element_blank(),
                       axis.line = element_blank(),
                       axis.text.x = element_blank(),
                       axis.text.y = element_blank(),
                       axis.ticks = element_blank(),
                       axis.title.x = element_blank(),
                       axis.title.y = element_blank(),
                       plot.title = element_blank()))
#+END_SRC

*** Let's zoom in

#+BEGIN_SRC R
ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) +
  geom_polygon(data = map_data("world"),
               aes(x = long, y = lat, group = group),
               fill = "whitesmoke",
	       colour = "gray10",
	       size = 0.2) +
  geom_path(data = substorms, aes(group = ID),
            alpha = scales::rescale(substorms$Wind.WMO., 
	            to = c(0,1)),
	    size = 0.8,
            color = "red") +
  coord_map(xlim = c(60,180),
            ylim = c(-20, 60)) +
  labs(x = "", y = "", colour = "Wind \n(knots)") + theme_opts
#+END_SRC

[[fig3/Rplot03.png]]

**** Map issue to fix
#+BEGIN_SRC R
wm <- map_data("world")

library("PBSmapping")
library("data.table")
data.table::setnames(wm, c("X","Y","PID","POS","region","subregion"))
worldmap = clipPolys(wm,
    xlim=c(60,180),
    ylim=c(-20, 60),
    keepExtra=TRUE)
#+END_SRC

**** Try again...
#+BEGIN_SRC R
ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) +
  geom_polygon(data = worldmap,
               aes(x = X, y = Y, group = PID),
               fill = "whitesmoke",
	       colour = "gray10",
	       size = 0.2) +
  geom_path(data = substorms, aes(group = ID),
            alpha = scales::rescale(substorms$Wind.WMO., 
	            to = c(0,1)),
	    size = 0.8,
            color = "red") +
  coord_map(xlim = c(60,180),
            ylim = c(-20, 60)) +
  labs(x = "", y = "", colour = "Wind \n(knots)") + theme_opts
#+END_SRC

[[fig3/Rplot04.png]]

*** Extract dates from the data

#+BEGIN_SRC R
# extract month and year for facetting later
library(lubridate)
substorms <- substorms %>%
  mutate(Month = month(as.Date(ISO_time)),
         Year = year(as.Date(ISO_time)))
#+END_SRC

*** facetted map
#+BEGIN_SRC R
ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) +
  geom_polygon(data = worldmap,
               aes(x = X, y = Y, group = PID),
               fill = "whitesmoke",
	       colour = "gray10",
	       size = 0.2) +
  geom_path(data = substorms, aes(group = ID),
            alpha = scales::rescale(substorms$Wind.WMO., 
	            to = c(0,1)),
	    size = 0.8,
            color = "red") +
  coord_map(xlim = c(60,180),
            ylim = c(-20, 60)) +
  labs(x = "", y = "", colour = "Wind \n(knots)") + theme_opts
  facet_wrap(~Year)
#+END_SRC

[[fig3/Rplot05.png]]

*** facetted map
#+BEGIN_SRC R
  + facet_wrap(~Month)
#+END_SRC

*** exercises

- highlight Katrina 2005:

[[fig3/Rplot10.png]]

- what were the 20 fastest storms on record?
